
generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Todo {
  id        Int      @id @default(autoincrement())
  title     String
  createdAt DateTime @default(now())
}

// Enum for family relationship types
enum FamilyRelation {
  FATHER
  MOTHER
  SON
  DAUGHTER
  SIBLING
  HUSBAND
  WIFE
  GRANDFATHER
  GRANDMOTHER
  GRANDSON
  GRANDDAUGHTER
  UNCLE
  AUNT
  NEPHEW
  NIECE
  COUSIN
  OTHER
}

enum AssetType {
  PROPERTY
  VEHICLE
  INVESTMENT
  OTHER
}

// Distribution type for Islamic agreements
enum DistributionType {
  FARAID      // Islamic inheritance law (fixed shares)
  HIBAH       // Gift during lifetime
  WASIYYAH    // Will (up to 1/3 for non-heirs)
  WAKAF       // Endowment
}

// Status of an agreement
enum AgreementStatus {
  DRAFT                    // Initial creation
  PENDING_SIGNATURES       // Waiting for beneficiaries to sign
  PENDING_WITNESS          // All beneficiaries signed, waiting for admin witness
  ACTIVE                   // Fully executed agreement
  COMPLETED                // Distribution completed
  CANCELLED                // Agreement cancelled
  EXPIRED                  // Agreement expired
}

// Central registry for IC numbers to ensure global uniqueness
// across User and NonRegisteredFamilyMember tables
model IcRegistry {
  icNumber    String   @id @unique
  createdAt   DateTime @default(now())
  
  // One-to-one relations (only one can be set at a time)
  user                      User?
  nonRegisteredFamilyMember NonRegisteredFamilyMember?
  
  @@map("ic_registry")
}

model User {
  id            String    @id
  name          String
  icNumber      String?   @unique
  address       String?
  phoneNumber   String?
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  sessions      Session[]
  accounts      Account[]
  assets        Asset[]
  
  // Family relationships where this user is the owner
  familyMembers            FamilyMember[] @relation("UserFamilyMembers")
  // Family relationships where this user is the related member
  relatedFamilyMembers     FamilyMember[] @relation("RelatedFamilyMembers")
  // Non-registered family members added by this user
  nonRegisteredFamilyMembers NonRegisteredFamilyMember[]
  
  // Agreements owned by this user (as the distributor)
  agreements    Agreement[]
  
  // Reference to IC registry for global uniqueness
  icRegistry    IcRegistry? @relation(fields: [icNumber], references: [icNumber], onDelete: SetNull)
  
  @@map("user")
}

// Junction table to link users as family members
model FamilyMember {
  // Change it to id String @id @default(cuid()) for production
  id            Int         @id @default(autoincrement()) 
  relation      FamilyRelation // The relation type (e.g., FATHER, MOTHER, SIBLING)
  
  // The user who created/owns this family link
  userId        String
  user          User           @relation("UserFamilyMembers", fields: [userId], references: [id], onDelete: Cascade)
  
  // The related family member (another user in the system)
  familyMemberUserId String
  familyMemberUser   User           @relation("RelatedFamilyMembers", fields: [familyMemberUserId], references: [id], onDelete: Cascade)
  
  // Agreement beneficiaries where this family member is a beneficiary
  agreementBeneficiaries AgreementBeneficiary[]
  
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // Prevent duplicate relationships between same users
  @@unique([userId, familyMemberUserId])
  @@index([userId])
  @@index([familyMemberUserId])
  @@map("family_member")
}

// For family members who are not yet registered in the system
// Can be deleted once a user with the same IC registers and confirms identity
model NonRegisteredFamilyMember {
  // Change it to id String @id @default(cuid()) for prod
  id            Int         @id @default(autoincrement())
  relation      FamilyRelation // The relation type
  
  // Family member details (not yet a registered user)
  name          String
  icNumber      String      @unique
  address       String?
  phoneNumber   String?
  
  // The user who added this non-registered family member
  userId        String
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Reference to IC registry for global uniqueness
  icRegistry    IcRegistry  @relation(fields: [icNumber], references: [icNumber], onDelete: Cascade)
  
  // Agreement beneficiaries where this non-registered family member is a beneficiary
  agreementBeneficiaries AgreementBeneficiary[]
  
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([userId])
  @@map("non_registered_family_member")
}

model Asset {
  // Change it to id String @id @default(cuid()) for prod
  id            Int         @id @default(autoincrement())
  name          String
  type          AssetType
  description   String?
  value         Float
  documentUrl   String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // The user who owns this asset
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Agreements where this asset is allocated
  agreementAssets AgreementAsset[]
  
  @@map("asset")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

// Admin model for system administrators who act as witnesses
model Admin {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  password      String
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Agreements witnessed by this admin
  witnessedAgreements Agreement[]

  @@map("admin")
}

// Main agreement model for Islamic distribution
model Agreement {
  id                String           @id @default(cuid())
  title             String
  description       String?
  distributionType  DistributionType
  status            AgreementStatus  @default(DRAFT)
  
  // Owner of the agreement (the person distributing assets)
  ownerId           String
  owner             User             @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  
  // Owner signature tracking
  ownerHasSigned    Boolean          @default(false)
  ownerSignedAt     DateTime?
  ownerSignatureRef String?          // Reference to signature document/hash
  
  // Witness (Admin)
  witnessId         String?
  witness           Admin?           @relation(fields: [witnessId], references: [id])
  witnessedAt       DateTime?
  
  // Agreement validity
  effectiveDate     DateTime?        // When agreement takes effect
  expiryDate        DateTime?        // Optional expiry
  
  // Timestamps
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  // Relations
  assets            AgreementAsset[]
  beneficiaries     AgreementBeneficiary[]

  @@index([ownerId])
  @@index([status])
  @@map("agreement")
}

// Junction table linking agreements to assets with optional allocation
model AgreementAsset {
  id            String    @id @default(cuid())
  
  agreementId   String
  agreement     Agreement @relation(fields: [agreementId], references: [id], onDelete: Cascade)
  
  assetId       Int
  asset         Asset     @relation(fields: [assetId], references: [id], onDelete: Cascade)
  
  // Optional: specific value allocated from this asset (if partial)
  allocatedValue      Float?
  allocatedPercentage Float?    // Percentage of asset included
  notes               String?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([agreementId, assetId])
  @@index([agreementId])
  @@index([assetId])
  @@map("agreement_asset")
}

// Tracks beneficiaries with their share and signature status
model AgreementBeneficiary {
  id            String    @id @default(cuid())
  
  agreementId   String
  agreement     Agreement @relation(fields: [agreementId], references: [id], onDelete: Cascade)
  
  // Beneficiary can be either a registered family member OR non-registered
  // Only one should be set at a time
  familyMemberId              Int?
  familyMember                FamilyMember? @relation(fields: [familyMemberId], references: [id], onDelete: SetNull)
  
  nonRegisteredFamilyMemberId Int?
  nonRegisteredFamilyMember   NonRegisteredFamilyMember? @relation(fields: [nonRegisteredFamilyMemberId], references: [id], onDelete: SetNull)
  
  // Distribution share
  sharePercentage   Float         // Percentage of total distribution
  shareDescription  String?       // E.g., "1/6 as per Faraid for mother"
  
  // Signature tracking
  hasSigned         Boolean       @default(false)
  signedAt          DateTime?
  signatureRef      String?       // Reference to signature document/hash
  
  // Status
  isAccepted        Boolean?      // null = pending, true = accepted, false = rejected
  rejectionReason   String?
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([agreementId])
  @@index([familyMemberId])
  @@index([nonRegisteredFamilyMemberId])
  @@map("agreement_beneficiary")
}
