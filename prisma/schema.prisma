
generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Todo {
  id        Int      @id @default(autoincrement())
  title     String
  createdAt DateTime @default(now())
}

// Enum for family relationship types
enum FamilyRelation {
  FATHER
  MOTHER
  SON
  DAUGHTER
  SIBLING
  SPOUSE
  GRANDFATHER
  GRANDMOTHER
  GRANDSON
  GRANDDAUGHTER
  UNCLE
  AUNT
  NEPHEW
  NIECE
  COUSIN
  OTHER
}

enum AssetType {
  PROPERTY
  VEHICLE
  INVESTMENT
  OTHER
}

// Central registry for IC numbers to ensure global uniqueness
// across User and NonRegisteredFamilyMember tables
model IcRegistry {
  icNumber    String   @id @unique
  createdAt   DateTime @default(now())
  
  // One-to-one relations (only one can be set at a time)
  user                      User?
  nonRegisteredFamilyMember NonRegisteredFamilyMember?
  
  @@map("ic_registry")
}

model User {
  id            String    @id
  name          String
  icNumber      String?   @unique
  address       String?
  phoneNumber   String?
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  sessions      Session[]
  accounts      Account[]
  assets        Asset[]
  
  // Family relationships where this user is the owner
  familyMembers            FamilyMember[] @relation("UserFamilyMembers")
  // Family relationships where this user is the related member
  relatedFamilyMembers     FamilyMember[] @relation("RelatedFamilyMembers")
  // Non-registered family members added by this user
  nonRegisteredFamilyMembers NonRegisteredFamilyMember[]
  
  // Reference to IC registry for global uniqueness
  icRegistry    IcRegistry? @relation(fields: [icNumber], references: [icNumber], onDelete: SetNull)
  
  @@map("user")
}

// Junction table to link users as family members
model FamilyMember {
  // Change it to id String @id @default(cuid()) for production
  id            Int         @id @default(autoincrement()) 
  relation      FamilyRelation // The relation type (e.g., FATHER, MOTHER, SIBLING)
  
  // The user who created/owns this family link
  userId        String
  user          User           @relation("UserFamilyMembers", fields: [userId], references: [id], onDelete: Cascade)
  
  // The related family member (another user in the system)
  familyMemberUserId String
  familyMemberUser   User           @relation("RelatedFamilyMembers", fields: [familyMemberUserId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // Prevent duplicate relationships between same users
  @@unique([userId, familyMemberUserId])
  @@index([userId])
  @@index([familyMemberUserId])
  @@map("family_member")
}

// For family members who are not yet registered in the system
// Can be deleted once a user with the same IC registers and confirms identity
model NonRegisteredFamilyMember {
  // Change it to id String @id @default(cuid()) for prod
  id            Int         @id @default(autoincrement())
  relation      FamilyRelation // The relation type
  
  // Family member details (not yet a registered user)
  name          String
  icNumber      String      @unique
  address       String?
  phoneNumber   String?
  
  // The user who added this non-registered family member
  userId        String
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Reference to IC registry for global uniqueness
  icRegistry    IcRegistry  @relation(fields: [icNumber], references: [icNumber], onDelete: Cascade)
  
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([userId])
  @@map("non_registered_family_member")
}

model Asset {
  // Change it to id String @id @default(cuid()) for prod
  id            Int         @id @default(autoincrement())
  name          String
  type          AssetType
  description   String?
  value         Float
  documentUrl   String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // The user who owns this asset
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@map("asset")

}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}
